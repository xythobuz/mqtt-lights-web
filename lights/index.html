<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="color-scheme" content="dark light">
        <title>Lights Control</title>
        <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-dark.min.css" rel="stylesheet">
    </head>

    <body>
        <div class="container text-center">
            <div class="row">
                <div class="col">
                    <h1>Lights Control</h1>
                </div>
            </div>

            <div class="row">
                <div class="col-2"></div>
                <div class="col-8">
                    <nav>
                        <div class="nav nav-tabs" id="nav-tab" role="tablist">
                            <button class="nav-link" id="nav-livingroom-tab" data-bs-toggle="tab" data-bs-target="#nav-livingroom" type="button" role="tab" aria-controls="nav-livingroom" aria-selected="false">
                                Livingroom
                            </button>
                            <button class="nav-link active" id="nav-bathroom-tab" data-bs-toggle="tab" data-bs-target="#nav-bathroom" type="button" role="tab" aria-controls="nav-bathroom" aria-selected="true">
                                Bathroom
                            </button>
                            <button class="nav-link" id="nav-help-tab" data-bs-toggle="tab" data-bs-target="#nav-help" type="button" role="tab" aria-controls="nav-help" aria-selected="false">
                                Help
                            </button>
                        </div>
                    </nav>
                </div>
                <div class="col-2"></div>
            </div>

            <div class="row">
                <div class="col-2"></div>
                <div class="col-8">
                    <hr>
                </div>
                <div class="col-2"></div>
            </div>

            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-bathroom" role="tabpanel" aria-labelledby="nav-bathroom-tab" tabindex="0">
                    <div class="row">
                        <div class="col">
                            <h2>Actors</h2>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col text-end">
                            <p>Lights<br><small>(will return to 'Auto' after 2h)</small></p>
                        </div>
                        <div class="col text-start">
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="bathroomradio" id="bathroomlightauto" autocomplete="off">
                                <label class="btn btn-outline-primary" for="bathroomlightauto">
                                    Auto
                                </label>
                                <input type="radio" class="btn-check" name="bathroomradio" id="bathroomlightbig" autocomplete="off">
                                <label class="btn btn-outline-success" for="bathroomlightbig">
                                    Big
                                </label>
                                <input type="radio" class="btn-check" name="bathroomradio" id="bathroomlightsmall" autocomplete="off">
                                <label class="btn btn-outline-info" for="bathroomlightsmall">
                                    Small
                                </label>
                                <input type="radio" class="btn-check" name="bathroomradio" id="bathroomlightoff" autocomplete="off">
                                <label class="btn btn-outline-dark" for="bathroomlightoff">
                                    Off
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-2"></div>
                        <div class="col-8">
                            <hr>
                        </div>
                        <div class="col-2"></div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <h2>Sensors</h2>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col text-end">
                            <p>Temperature</p>
                        </div>
                        <div class="col text-start" id="bathtemp">
                            <p>Unknown</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col text-end">
                            <p>Relative Humidity</p>
                        </div>
                        <div class="col text-start" id="bathhumid">
                            <p>Unknown</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col text-end">
                            <p>tVOC</p>
                        </div>
                        <div class="col text-start" id="bathtvoc">
                            <p>Unknown</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col text-end">
                            <p>eCO2</p>
                        </div>
                        <div class="col text-start" id="batheco2">
                            <p>Unknown</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col text-end">
                            <p>Air Pressure</p>
                        </div>
                        <div class="col text-start" id="bathpress">
                            <p>Unknown</p>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="nav-livingroom" role="tabpanel" aria-labelledby="nav-livingroom-tab" tabindex="0">
                    <div class="row">
                        <div class="col">
                            <p>No controls available yet.</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col text-end">
                            <p>Workspace Lights</p>
                        </div>
                        <div class="col text-start">
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="workspaceradio" id="workspaceon" autocomplete="off">
                                <label class="btn btn-outline-primary" for="workspaceon">
                                    On
                                </label>
                                <input type="radio" class="btn-check" name="workspaceradio" id="workspaceoff" autocomplete="off">
                                <label class="btn btn-outline-dark" for="workspaceoff">
                                    Off
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col text-end">
                            <p>TV Lights</p>
                        </div>
                        <div class="col text-start">
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="tvradio" id="tvon" autocomplete="off">
                                <label class="btn btn-outline-primary" for="tvon">
                                    On
                                </label>
                                <input type="radio" class="btn-check" name="tvradio" id="tvoff" autocomplete="off">
                                <label class="btn btn-outline-dark" for="tvoff">
                                    Off
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col text-end">
                            <p>Kitchen Lights</p>
                        </div>
                        <div class="col text-start">
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="kitchenradio" id="kitchenon" autocomplete="off">
                                <label class="btn btn-outline-primary" for="kitchenon">
                                    On
                                </label>
                                <input type="radio" class="btn-check" name="kitchenradio" id="kitchenoff" autocomplete="off">
                                <label class="btn btn-outline-dark" for="kitchenoff">
                                    Off
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="nav-help" role="tabpanel" aria-labelledby="nav-help-tab" tabindex="0">
                    <div class="row">
                        <div class="col">
                            <p><a href=".">Refresh page</a></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-2"></div>
                        <div class="col-8">
                            <p>Please wait after opening the page until the buttons change to reflect the current state of the lights. If that doesn't happen after a couple of seconds, there is probably a connection problem.</p>
                        </div>
                        <div class="col-2"></div>
                    </div>
                    <div class="row">
                        <div class="col-2"></div>
                        <div class="col-8">
                            <p><b>Please note:</b> this only works when the MQTT broker and the NodeRED logic are working properly. Also not all web browsers support web socket connections to the MQTT broker. Firefox gives problems, so try a Chromium based browser instead.</p>
                        </div>
                        <div class="col-2"></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-2"></div>
                <div class="col-8">
                    <hr>
                </div>
                <div class="col-2"></div>
            </div>

            <div class="row">
                <div class="col-2"></div>
                <div class="col-8">
                    <p class="text-muted">By <a class="text-decoration-none" href="https://www.xythobuz.de">xythobuz</a>. <a class="text-decoration-none" href="https://git.xythobuz.de/thomas/lights-web">Source</a>.</p>
                </div>
                <div class="col-2"></div>
            </div>
        </div>

        <!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

        <script src="credentials.js"></script>
        <script src="lights.js"></script>

        <script>
            const btnsBath = document.querySelectorAll("#bathroomlightauto, #bathroomlightbig, #bathroomlightsmall, #bathroomlightoff")

            // handle changes to bathroom lights
            subscribeTopic("bathroom/force_light", function (msg) {
                // clear all buttons
                for (const btn of btnsBath) {
                    btn.checked = false
                }

                // activate proper button
                if (msg == "none") {
                    const btn = document.querySelector("#bathroomlightauto")
                    btn.checked = true
                } else if (msg == "big") {
                    const btn = document.querySelector("#bathroomlightbig")
                    btn.checked = true
                } else if (msg == "small") {
                    const btn = document.querySelector("#bathroomlightsmall")
                    btn.checked = true
                } else if (msg == "off") {
                    const btn = document.querySelector("#bathroomlightoff")
                    btn.checked = true
                } else {
                    console.log("unknown msg " + msg)
                }
            })

            // set new bathroom light state
            for (const btn of btnsBath) {
                btn.addEventListener('change', function (e) {
                    if (this.checked) {
                        if (this == document.querySelector("#bathroomlightauto")) {
                            setTopic("bathroom/force_light", "none")
                        } else if (this == document.querySelector("#bathroomlightbig")) {
                            setTopic("bathroom/force_light", "big")
                        } else if (this == document.querySelector("#bathroomlightsmall")) {
                            setTopic("bathroom/force_light", "small")
                        } else if (this == document.querySelector("#bathroomlightoff")) {
                            setTopic("bathroom/force_light", "off")
                        } else {
                            console.log("unknown btn value " + this.value)
                        }
                    }
                })
            }

            // handle bathroom sensors
            subscribeTopic("bathroom/temperature", function (msg) {
                const txt = document.querySelector("#bathtemp")
                txt.innerHTML = "<p>" + parseInt(msg) + " °C</p>"
            })
            subscribeTopic("bathroom/humidity", function (msg) {
                const txt = document.querySelector("#bathhumid")
                txt.innerHTML = "<p>" + parseInt(msg) + " %</p>"
            })
            subscribeTopic("bathroom/pressure", function (msg) {
                const txt = document.querySelector("#bathpress")
                txt.innerHTML = "<p>" + parseInt(msg / 100.0) + " mbar</p>"
            })
            subscribeTopic("bathroom/tvoc", function (msg) {
                const txt = document.querySelector("#bathtvoc")
                txt.innerHTML = "<p>" + parseInt(msg) + " ppb</p>"
            })
            subscribeTopic("bathroom/eco2", function (msg) {
                const txt = document.querySelector("#batheco2")
                txt.innerHTML = "<p>" + parseInt(msg) + " ppm</p>"
            })
        </script>
    </body>
</html>
